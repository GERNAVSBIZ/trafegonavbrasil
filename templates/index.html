<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise de Malha Aérea - Sistema Avançado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@1.1.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; } ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 3px; } ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; } ::-webkit-scrollbar-thumb:hover { background: #94a3b8; } body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; } .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2); } .glass-dark { background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); } @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } } @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } } .animate-fadeInUp { animation: fadeInUp 0.6s ease-out; } .animate-pulse-custom { animation: pulse 2s infinite; } .card-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); } .card-hover:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); } .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); transition: all 0.3s ease; } .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4); } .btn-secondary { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); transition: all 0.3s ease; } .btn-secondary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(240, 147, 251, 0.4); } .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; } .stat-card-green { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); } .stat-card-orange { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); } .stat-card-purple { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #1f2937; } .spinner { border-top-color: transparent; animation: spin 1s linear infinite; } @keyframes spin { to { transform: rotate(360deg); } } #toast { transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); } .table-row:hover { background: linear-gradient(90deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); } .chart-container { position: relative; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); }
        .table-filter-input { width: 100%; padding: 4px 8px; border-radius: 6px; border: 1px solid #e2e8f0; font-size: 12px; }
        .table-filter-input:focus { border-color: #667eea; outline: none; box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2); }
    </style>
</head>
<body>
    <div id="login-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50"><div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center"><h2 class="text-2xl font-bold mb-4 text-gray-800">Acesso ao Sistema</h2><p class="text-gray-600 mb-6">Por favor, faça login para continuar.</p><form id="loginForm" class="space-y-4"><input type="email" id="email" placeholder="Seu e-mail" required class="w-full px-4 py-2 border rounded-lg"><input type="password" id="password" placeholder="Sua senha" required class="w-full px-4 py-2 border rounded-lg"><button type="submit" class="w-full btn-primary text-white font-semibold py-3 px-4 rounded-xl">Entrar</button></form><p id="login-error" class="text-red-500 mt-4 text-sm"></p></div></div><div id="user-info" class="hidden no-print fixed top-5 right-5 glass-dark text-white py-2 px-4 rounded-xl shadow-lg z-50 flex items-center gap-4"><span id="user-email" class="text-sm"></span><button id="logoutButton" class="bg-red-500 hover:bg-red-600 rounded-full w-8 h-8 flex items-center justify-center"><i data-lucide="log-out" class="w-4 h-4 text-white"></i></button></div><div id="main-app" class="hidden"><div id="app" class="relative z-10 container mx-auto p-4 md:p-6 lg:p-8 max-w-7xl"><header class="glass rounded-2xl p-6 mb-8 card-hover animate-fadeInUp"><div class="flex flex-wrap items-center justify-between gap-4"><div class="flex items-center"><div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center mr-4 animate-pulse-custom no-print"><i data-lucide="plane" class="w-6 h-6 text-white"></i></div><div><h1 class="text-3xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent">Análise de Malha Aérea</h1><p class="text-gray-600 text-sm">Sistema Avançado de Monitoramento</p><p id="data-period-display" class="text-sm text-indigo-800 font-medium mt-1"></p></div></div><div class="flex items-center space-x-2"><div class="w-3 h-3 bg-green-400 rounded-full animate-pulse no-print"></div><span class="text-sm text-gray-600">Sistema Online</span></div></div></header><main class="grid grid-cols-1 xl:grid-cols-4 gap-8"><div class="xl-col-span-1 space-y-6"><div class="glass rounded-2xl p-6 card-hover animate-fadeInUp no-print" style="animation-delay: 0.1s"><div class="flex items-center mb-4"><div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center mr-3"><i data-lucide="upload" class="w-4 h-4 text-white"></i></div><h2 class="text-xl font-semibold text-gray-800">Upload de Dados</h2></div><form id="uploadForm" class="space-y-4"><div class="relative">
    <input type="file" id="dataFile" accept=".dat,.dta" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" multiple webkitdirectory>
    <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:border-blue-400 transition-colors"><i data-lucide="folder-up" class="w-8 h-8 text-gray-400 mx-auto mb-2"></i><p id="file-upload-text" class="text-sm text-gray-600">Clique para selecionar uma pasta</p><p class="text-xs text-gray-400 mt-1">Ex: Pasta com SBIZ_...dat, SBGR_...dat</p></div></div><button id="uploadButton" type="submit" class="w-full btn-primary text-white font-semibold py-3 px-4 rounded-xl disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"><span id="button-text">Processar Ficheiro(s)</span><div id="loading-spinner" class="spinner w-5 h-5 border-4 border-white rounded-full hidden"></div></button></form>
    
    <div id="save-section" class="hidden mt-4 space-y-2 border-t pt-4">
        <label for="analysisName" class="block text-sm font-medium text-gray-700">Nome da Análise</label>
        <input type="text" id="analysisName" placeholder="Ex: Semana 38 - Nacional" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
        <button id="saveAnalysisButton" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-xl flex items-center justify-center gap-2">
            <i data-lucide="save" class="w-4 h-4"></i>
            <span>Salvar Análise na Nuvem</span>
        </button>
    </div>

    </div><div class="glass rounded-2xl p-6 card-hover animate-fadeInUp no-print" style="animation-delay: 0.15s"><div class="flex items-center mb-4"><div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-lg flex items-center justify-center mr-3"><i data-lucide="history" class="w-4 h-4 text-white"></i></div><h2 class="text-xl font-semibold text-gray-800">Histórico de Análises</h2></div><div id="upload-history-list" class="space-y-2 max-h-60 overflow-y-auto pr-2"><p class="text-sm text-gray-500 text-center py-4">Carregando histórico...</p></div></div><div class="glass rounded-2xl p-6 card-hover animate-fadeInUp no-print" style="animation-delay: 0.2s"><div class="flex items-center mb-4"><div class="w-8 h-8 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center mr-3"><i data-lucide="sliders-horizontal" class="w-4 h-4 text-white"></i></div><h2 class="text-xl font-semibold text-gray-800">Painel de Controlo</h2></div><div class="space-y-4">
        <label class="block text-sm font-medium text-gray-700">Período de Análise Salva</label>
        <div class="space-y-2"><input type="date" id="analysisStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg"><input type="date" id="analysisEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></div>
        <label for="aerodromoFilter" class="block text-sm font-medium text-gray-700">Visão da Análise</label>
        <select id="aerodromoFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            <option value="all">Visão Macro (Todos Aeródromos)</option>
        </select>
        <button id="runAnalysisButton" class="w-full btn-primary text-white font-semibold py-3 px-4 rounded-xl flex items-center justify-center gap-2"><i data-lucide="bar-chart-2" class="w-4 h-4"></i><span>Analisar Período Salvo</span></button>
        <button id="generatePdfButton" disabled class="w-full bg-gray-400 text-white font-semibold py-2 px-4 rounded-lg flex items-center justify-center gap-2 cursor-not-allowed"><i data-lucide="file-text" class="w-4 h-4"></i> Relatório PDF (desativado)</button>
    </div></div><div class="glass rounded-2xl p-6 card-hover animate-fadeInUp" style="animation-delay: 0.3s"><div class="flex items-center mb-4"><div class="w-8 h-8 bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-lg flex items-center justify-center mr-3"><i data-lucide="alert-triangle" class="w-4 h-4 text-white"></i></div><h2 class="text-xl font-semibold text-gray-800">Alertas e Insights</h2></div><ul id="anomaly-alerts-list" class="space-y-2 text-sm text-gray-600 max-h-40 overflow-y-auto pr-2 mb-4 border-b pb-4"><li>Nenhum dado carregado.</li></ul><div class="space-y-3"><div class="flex justify-between items-center"><span class="text-sm text-gray-600">Registos Carregados</span><span id="loaded-count" class="font-semibold text-blue-600">0</span></div><div class="flex justify-between items-center"><span class="text-sm text-gray-600">Última Atualização</span><span id="last-update" class="font-semibold text-gray-600">-</span></div></div></div></div><div class="xl-col-span-3 space-y-6">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 animate-fadeInUp" style="animation-delay: 0.4s"><div class="stat-card rounded-2xl p-6 card-hover"><div class="flex items-center justify-between"><div><p class="text-white/80 text-sm">Total de Voos</p><p id="total-voos" class="text-3xl font-bold text-white">0</p></div><i data-lucide="plane" class="w-8 h-8 text-white/60"></i></div></div><div class="stat-card-green rounded-2xl p-6 card-hover"><div class="flex items-center justify-between"><div><p class="text-white/80 text-sm">Voos Comerciais</p><p id="voos-comerciais" class="text-3xl font-bold text-white">0</p></div><i data-lucide="building" class="w-8 h-8 text-white/60"></i></div></div>
    <div class="stat-card-orange rounded-2xl p-6 card-hover"><div class="flex items-center justify-between"><div><p class="text-white/80 text-sm">Sobrevoos</p><p id="sobrevoos" class="text-3xl font-bold text-white">0</p></div><i data-lucide="git-commit" class="w-8 h-8 text-white/60"></i></div></div>
    <div class="stat-card-purple rounded-2xl p-6 card-hover"><div class="flex items-center justify-between"><div><p class="text-gray-700/80 text-sm">Horário de Pico</p><p id="horario-pico" class="text-3xl font-bold text-gray-800">-</p></div><i data-lucide="trending-up" class="w-8 h-8 text-gray-600"></i></div></div></div>

    <div id="macro-view-charts" class="space-y-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="glass rounded-2xl p-6 card-hover chart-container"><h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center"><i data-lucide="bar-chart-3" class="w-5 h-5 mr-2 text-indigo-500"></i>Ranking de Aeroportos por Movimento</h3><div class="relative h-80"><canvas id="rankingAeroportosChart"></canvas></div></div><div class="glass rounded-2xl p-6 card-hover chart-container"><h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center"><i data-lucide="route" class="w-5 h-5 mr-2 text-cyan-500"></i>Top 10 Rotas Nacionais</h3><div class="relative h-80"><canvas id="topRotasChart"></canvas></div></div></div>
        <div class="glass rounded-2xl p-6 card-hover chart-container"><h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center"><i data-lucide="layers" class="w-5 h-5 mr-2 text-amber-500"></i>Perfil Operacional (IFR vs VFR)</h3><div class="relative" style="height: 350px;"><canvas id="perfilOperacionalChart"></canvas></div></div>
        <div class="glass rounded-2xl p-6 card-hover chart-container"><h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center"><i data-lucide="line-chart" class="w-5 h-5 mr-2 text-red-500"></i>Pulso do Tráfego Aéreo Nacional (por Dia)</h3><div class="relative" style="height: 300px;"><canvas id="pulsoTrafegoChart"></canvas></div></div>
        <div class="glass rounded-2xl p-6 card-hover chart-container"><h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center"><i data-lucide="layout-grid" class="w-5 h-5 mr-2 text-green-500"></i>Mapa de Calor da Atividade (Hora vs Dia da Semana)</h3><div class="relative" style="height: 300px;"><canvas id="heatmapAtividadeChart"></canvas></div></div>
    </div>
    <div id="detailed-view-charts" class="hidden space-y-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="glass rounded-2xl p-6 card-hover chart-container"><h3 id="flightsByRuleChart-title" class="text-lg font-semibold text-gray-800 mb-4 flex items-center"><i data-lucide="pie-chart" class="w-5 h-5 mr-2 text-blue-500"></i> Voos por Regra</h3><div class="relative h-64"><canvas id="flightsByRuleChart"></canvas></div></div><div class="glass rounded-2xl p-6 card-hover chart-container"><h3 id="flightsByDestChart-title" class="text-lg font-semibold text-gray-800 mb-4 flex items-center"><i data-lucide="map-pin" class="w-5 h-5 mr-2 text-green-500"></i> Destinos Principais</h3><div class="relative h-64"><canvas id="flightsByDestChart"></canvas></div></div></div>
        <div class="glass rounded-2xl p-6 card-hover chart-container"><h3 id="hourlyFlightsChart-title" class="text-lg font-semibold text-gray-800 mb-4 flex items-center"><i data-lucide="clock" class="w-5 h-5 mr-2 text-purple-500"></i> Distribuição por Horário</h3><div class="relative" style="height: 300px;"><canvas id="hourlyFlightsChart"></canvas></div></div>
        <div class="glass rounded-2xl p-6 card-hover chart-container"><h3 id="dayOfWeekChart-title" class="text-lg font-semibold text-gray-800 mb-4 flex items-center"><i data-lucide="calendar-days" class="w-5 h-5 mr-2 text-red-500"></i> Movimento por Dia da Semana</h3><div class="relative" style="height: 300px;"><canvas id="dayOfWeekChart"></canvas></div></div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="glass rounded-2xl p-6 card-hover chart-container"><h3 id="aircraftTypesChart-title" class="text-lg font-semibold text-gray-800 mb-4 flex items-center"><i data-lucide="plane-takeoff" class="w-5 h-5 mr-2 text-lime-500"></i> Top 5 Aeronaves</h3><div class="relative h-64"><canvas id="aircraftTypesChart"></canvas></div></div></div>
    </div>
    <div class="glass rounded-2xl p-6 card-hover animate-fadeInUp" style="animation-delay: 1.1s"><div class="flex flex-wrap items-center justify-between mb-6 gap-4"><h3 class="text-lg font-semibold text-gray-800 flex items-center"><i data-lucide="table" class="w-5 h-5 mr-2 text-indigo-500"></i> Registos de Voo</h3><div class="flex items-center gap-2"><button id="downloadCsvButton" class="btn-secondary text-white py-2 px-4 rounded-lg text-sm font-medium flex items-center gap-2 no-print"><i data-lucide="download" class="w-4 h-4"></i> Download CSV</button></div></div><div class="overflow-auto rounded-xl border border-gray-200" style="max-height: 500px;"><table class="w-full text-sm"><thead class="bg-gray-50 sticky top-0"><tr class="no-print"><th class="px-4 py-3 text-left font-semibold text-gray-700">Aeródromo</th><th class="px-4 py-3 text-left font-semibold text-gray-700">Data/Hora (UTC)</th><th class="px-4 py-3 text-left font-semibold text-gray-700">Matrícula</th><th class="px-4 py-3 text-left font-semibold text-gray-700">Tipo Aeronave</th><th class="px-4 py-3 text-left font-semibold text-gray-700">Tipo Voo</th><th class="px-4 py-3 text-left font-semibold text-gray-700">Origem</th><th class="px-4 py-3 text-left font-semibold text-gray-700">Destino</th><th class="px-4 py-3 text-left font-semibold text-gray-700">Regra</th><th class="px-4 py-3 text-left font-semibold text-gray-700">Pista</th></tr><tr id="table-filters" class="no-print"><th class="px-2 py-2"><input type="text" placeholder="Filtrar..." data-column="aerodromo" class="table-filter-input"></th><th class="px-2 py-2"><input type="text" placeholder="Filtrar..." data-column="timestamp" class="table-filter-input"></th><th class="px-2 py-2"><input type="text" placeholder="Filtrar..." data-column="matricula" class="table-filter-input"></th><th class="px-2 py-2"><input type="text" placeholder="Filtrar..." data-column="tipo_aeronave" class="table-filter-input"></th><th class="px-2 py-2"><input type="text" placeholder="Filtrar..." data-column="flight_class" class="table-filter-input"></th><th class="px-2 py-2"><input type="text" placeholder="Filtrar..." data-column="origem" class="table-filter-input"></th><th class="px-2 py-2"><input type="text" placeholder="Filtrar..." data-column="destino" class="table-filter-input"></th><th class="px-2 py-2"><input type="text" placeholder="Filtrar..." data-column="regra_voo" class="table-filter-input"></th><th class="px-2 py-2"><input type="text" placeholder="Filtrar..." data-column="pista" class="table-filter-input"></th></tr></thead><tbody id="dataTableBody"><tr><td colspan="9" class="text-center p-12 text-gray-500"><i data-lucide="inbox" class="w-12 h-12 mx-auto mb-4 text-gray-300"></i><p>Aguardando análise de período...</p></td></tr></tbody></table></div></div></div></main></div></div>
    
    <div id="toast" class="fixed top-5 right-5 glass-dark text-white py-3 px-6 rounded-xl shadow-lg opacity-0 transform translate-y-[-20px] z-50">
        <div class="flex items-center gap-3"><i id="toast-icon" data-lucide="check-circle" class="w-5 h-5"></i><span id="toast-message"></span></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
                apiKey: "AIzaSyB2a4rPCyDEFhfSbbEJaD_5_78Oe69upMY",
                authDomain: "trafegonavbrasil.firebaseapp.com",
                projectId: "trafegonavbrasil",
                storageBucket: "trafegonavbrasil.firebasestorage.app",
                messagingSenderId: "406128200893",
                appId: "1:406128200893:web:93722521344fdd60cd7bd4",
                measurementId: "G-8LFLG5E8KS"
            };
            
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            
            // ... (Declaração de constantes, como na versão anterior) ...
            const loginOverlay = document.getElementById('login-overlay');
            const mainApp = document.getElementById('main-app');
            const loginForm = document.getElementById('loginForm');
            const loginError = document.getElementById('login-error');
            const userInfo = document.getElementById('user-info');
            const userEmail = document.getElementById('user-email');
            const logoutButton = document.getElementById('logoutButton');
            const uploadForm = document.getElementById('uploadForm');
            const dataFile = document.getElementById('dataFile');
            const uploadButton = document.getElementById('uploadButton');
            const buttonText = document.getElementById('button-text');
            const loadingSpinner = document.getElementById('loading-spinner');
            const tableBody = document.getElementById('dataTableBody');
            const downloadCsvButton = document.getElementById('downloadCsvButton');
            const uploadHistoryList = document.getElementById('upload-history-list');
            const analysisStartDate = document.getElementById('analysisStartDate');
            const analysisEndDate = document.getElementById('analysisEndDate');
            const runAnalysisButton = document.getElementById('runAnalysisButton');
            const fileUploadText = document.getElementById('file-upload-text');
            const aerodromoFilter = document.getElementById('aerodromoFilter');
            const macroView = document.getElementById('macro-view-charts');
            const detailedView = document.getElementById('detailed-view-charts');
            const tableFilters = document.querySelectorAll('#table-filters .table-filter-input');
            const saveSection = document.getElementById('save-section');
            const saveAnalysisButton = document.getElementById('saveAnalysisButton');
            
            let allFlightData = [];
            let processedFilesData = [];
            let charts = {};
            let toastTimeoutId = null;

            auth.onAuthStateChanged(user => {
                if (user) {
                    loginOverlay.classList.add('hidden');
                    mainApp.classList.remove('hidden');
                    userInfo.classList.remove('hidden');
                    userEmail.textContent = user.email;
                    fetchUploadHistory();
                } else {
                    loginOverlay.classList.remove('hidden');
                    mainApp.classList.add('hidden');
                    userInfo.classList.add('hidden');
                }
                lucide.createIcons();
            });

            loginForm.addEventListener('submit', (e) => { e.preventDefault(); const email = document.getElementById('email').value; const password = document.getElementById('password').value; loginError.textContent = ''; auth.signInWithEmailAndPassword(email, password).catch(error => { console.error('Erro de login:', error); loginError.textContent = 'E-mail ou senha inválidos.'; }); });
            logoutButton.addEventListener('click', () => { auth.signOut(); });
            // ... (O resto do seu JavaScript, idêntico à versão funcional anterior) ...
        });
    </script>
</body>
</html>

